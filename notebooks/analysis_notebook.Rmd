---
title: "Billiards and Tilts Analysis Notebook"
author: "Shanaathanan Modchalingam"
output: 
  html_notebook:
    toc: true
    toc_float: true
    number_sections: true
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE, warning=FALSE}
rm(list = ls())      # clean environment

source("../src/helper_funcs.R")
source("../scripts/figure_funcs.R") 
library(data.table)
library(tidyverse)
library(ggbeeswarm)
library(ez) #for ANOVAs
library(effectsize) # for eta-squared
library(plotly)

options(dplyr.summarise.inform=F)

# vars
omnibus_path <- "../data/processed/omnibus/omnibus_raw.csv"

# convert the above into a list
pallete_list <- c("rot_c" = "#d40000",
             "rot_nc" = "#f9982c",
             "tilt_c" = "#07509b",
             "tilt_nc" = "#5fb696",
             "rot_15_c" = "#740000",
             "rot_15_nc" = "#99982c",
             "none" = "#d40000",
             "half" = "#5fb696",
             "full" = "#07509b",
             "wait" = "#99982c")

```



## Load all of the throw data



```{r}
#load omnibus dataframe
omnibus_df <- read_delim("../data/processed/omnibus/omnibus_raw.csv", 
                            delim = ",", 
                            col_types = cols(.default = col_double(), 
                                             type = col_factor(),
                                             ppid = col_factor(),
                                             exp_label = col_factor(),
                                             experiment = col_factor(),
                                             hand = col_factor(),
                                             camera_tilt = col_factor(),
                                             surface_tilt = col_factor(),
                                             target = col_factor(),
                                             test_type = col_factor(),
                                             prior_anim = col_factor(),
                                             baseline_block = col_factor(),
                                             task_type = col_factor(),
                                             surface = col_factor(),
                                             anim_type = col_factor()))

original_exps <- c("rot15_cued_tilt", "rot15_uncued", "tilt_uncued_rot", 
                   "tilt_uncued_norot", "tilt_cued_rot", "tilt_cued_norot")
```

# Visualizing data (univariate)

```{r}
test_ppt <- 3

test_df <- omnibus_df %>% filter(ppid == test_ppt)


trial <- 250
trial_df <- filter(test_df, trial_num == trial)

x <- trial_df$flick_velocity_x
y <- trial_df$flick_velocity_y
z <- trial_df$flick_velocity_z

x2 <- trial_df$flick_direction_x
y2 <- trial_df$flick_direction_y
z2 <- trial_df$flick_direction_z

# plot both
plot_ly(x = c(0, x), y = c(0, y), z = c(0, z), type = "scatter3d", mode = "lines") %>%
  add_trace(x = c(0, x2), y = c(0, y2), z = c(0, z2), type = "scatter3d", mode = "lines") %>%
  layout(scene = list(xaxis = list(title = "x"),
                      yaxis = list(title = "y"),
                      zaxis = list(title = "z")))

# note: this is a rotated trial
```


```{r}

```


```{r}
# plot distribution of error_size
p <- ggplot(omnibus_df, aes(x = error_size)) +
  geom_histogram(binwidth = .5) +
  theme_minimal() +
  theme(text = element_text(size = 11)) +
  labs(x = "Error Size (cm)", y = "Count")

p
```

# Original Experiments

### Omnibus Plot for ANGLES
Note: Blues = Acceleration Perturbations
```{r}
# rest of the exps
data_per_group <- omnibus_df %>%
  filter(exp_label == "original_exps") %>%
  group_by(experiment, test_type, trial_num) %>%
  summarise(
    mean_deviation = mean(throw_deviation),
    ci_deviation = vector_confint(throw_deviation),
    .groups = "drop"
  )

# set up plot
p <- data_per_group %>%
  ggplot(
    aes(
      x = trial_num, y = mean_deviation, colour = experiment
    )
  ) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(
    x = "Trial Number",
    y = "Throw Angle (°)"
  )

# add horizontal lines
p <- p +
  geom_hline(
    yintercept = c(0, -30), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(-15), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  )

# p <- p +
#   scale_y_continuous(
#     limits = c(-10, 35),
#     breaks = c(0, 15, 30),
#     labels = c(0, 15, 30)
#   ) +
#   scale_x_continuous(
#     limits = c(0, 180),
#     breaks = c(0, 60, 120, 180),
#     labels = c(0, 60, 120, 180)
#   )

# set font size to 11
p <- p +
  theme(text = element_text(size = 11))

# add confidence intervals and data points
p <- p + geom_ribbon(
  aes(
    ymin = mean_deviation - ci_deviation,
    ymax = mean_deviation + ci_deviation,
    fill = experiment
  ), colour = NA, alpha = 0.3
  ) + geom_line()

# set colour palette
p <- p + scale_colour_manual(values = c(
  pallete_list[["tilt_c"]], pallete_list[["tilt_nc"]],
  pallete_list[["rot_c"]], pallete_list[["rot_nc"]],
  pallete_list[["rot_15_c"]], pallete_list[["rot_15_nc"]]
)) + scale_fill_manual(values = c(
  pallete_list[["tilt_c"]], pallete_list[["tilt_nc"]],
  pallete_list[["rot_c"]], pallete_list[["rot_nc"]],
  pallete_list[["rot_15_c"]], pallete_list[["rot_15_nc"]]
))


# # save
# if (save_plots) {
#   ggsave(
#   p,
#   filename = "../plots/paper_figs/sr_30_training.pdf", device = "pdf",
#   height = 4, width = 6
#   )
#   }

ggplotly(p)

# p
```
### Trial sets of interest only
Note: Blues = Acceleration Perturbations
```{r}
# filter out just the trials of interest
data_per_group <- data_per_group %>%
  filter(
    test_type != "other"
  ) 
# add a dummy column with repeating sequence 
# NOTE: this can't be combined with above since we are using nrow
data_per_group <- data_per_group %>% 
  mutate(dummy_x = rep(1:(nrow(data_per_group)/6), 
                       length.out = nrow(data_per_group)))

# set up plot
p <- data_per_group %>%
  ggplot(
    aes(
      x = dummy_x, y = mean_deviation, colour = experiment
    )
  ) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(
    x = "Trial Number",
    y = "Throw Angle (°)"
  )

# add horizontal lines
p <- p +
  geom_hline(
    yintercept = c(0, -30), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(-15), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  )

# add confidence intervals and data points
for (unique_test_type in unique(data_per_group$test_type)) {
  # get the data for this block
  to_plot_data <- filter(data_per_group, test_type == unique_test_type)

  p <- p + geom_ribbon(
    data = to_plot_data,
    aes(
      ymin = mean_deviation - ci_deviation,
      ymax = mean_deviation + ci_deviation,
      fill = experiment
    ), colour = NA, alpha = 0.3
    ) + geom_line(
      data = to_plot_data
    )
}

# set colour palette
p <- p + scale_colour_manual(values = c(
  pallete_list[["tilt_c"]], pallete_list[["tilt_nc"]],
  pallete_list[["rot_c"]], pallete_list[["rot_nc"]],
  pallete_list[["rot_15_c"]], pallete_list[["rot_15_nc"]]
)) + scale_fill_manual(values = c(
  pallete_list[["tilt_c"]], pallete_list[["tilt_nc"]],
  pallete_list[["rot_c"]], pallete_list[["rot_nc"]],
  pallete_list[["rot_15_c"]], pallete_list[["rot_15_nc"]]
))

ggplotly(p)
```


### Plots for ERROR
Note: Blues = Acceleration Perturbations
```{r}
ggplotly(plot_original_learning_curve(omnibus_path))
```

visible vs non-visible tilt doesn't affect the 15-degree rotation condition. But affects all other conditions. So 15-degree rotation

Note: Blues = Acceleration Perturbations
```{r}
ggplotly(plot_original_rebound(omnibus_path))
```



# Animated Surface Follow-up

### Omnibus Plot for ANGLES
```{r}
# isolate animate_surface exp
data_per_group <- omnibus_df %>%
  filter(exp_label == "animate_surface") %>%
  group_by(prior_anim, block_num, trial_num_in_block, trial_num) %>%
  summarise(
    mean_deviation = mean(throw_deviation),
    ci_deviation = vector_confint(throw_deviation)
  )

# set up plot
p <- data_per_group %>%
  ggplot(
    aes(
      x = trial_num, y = mean_deviation,
      ymin = mean_deviation - ci_deviation,
      ymax = mean_deviation + ci_deviation
    )
  ) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(
    x = "Trial Number",
    y = "Throw Angle (°)"
  )

# add horizontal lines
p <- p +
  geom_hline(
    yintercept = c(0, -30), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(-15), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  )

# p <- p +
#   scale_y_continuous(
#     limits = c(-10, 35),
#     breaks = c(0, 15, 30),
#     labels = c(0, 15, 30)
#   ) +
#   scale_x_continuous(
#     limits = c(0, 180),
#     breaks = c(0, 60, 120, 180),
#     labels = c(0, 60, 120, 180)
#   )

# set font size to 11
p <- p +
  theme(text = element_text(size = 11))

# repeat for prior_anim == "half", "full" and "wait"
for (unique_prior_anim in unique(data_per_group$prior_anim)) {
  # get the data for this block
  to_plot_data <- filter(data_per_group, prior_anim == unique_prior_anim)
  # loop through the unique blocks in to_plot_data
  for (block in unique(to_plot_data$block_num)) {
    # get the data for this block
    block_data <- filter(to_plot_data, block_num == block)
    # add the data, use the pallete_list to get the colour
    p <- p + geom_ribbon(
      data = block_data,
      aes(fill = prior_anim),
      colour = NA, alpha = 0.3
      ) + geom_line(
      data = block_data,
      aes(colour = prior_anim))
    
  }
}


# # save
# if (save_plots) {
#   ggsave(
#   p,
#   filename = "../plots/paper_figs/sr_30_training.pdf", device = "pdf",
#   height = 4, width = 6
#   )
#   }

ggplotly(p)
# p
```

## Difference between half and full animation washout trials
```{r}
# first, isolate the data
data <- omnibus_df %>%
  filter(
    exp_label == "animate_surface",
    baseline_block == FALSE,
    test_type == "washout_anim"
    )

data_per_ppt <- data %>%
  group_by(ppid, prior_anim, trial_num_in_block) %>%
  summarise(
    ppt_mean_deviation = median(throw_deviation),
    ppt_ci_deviation = vector_confint(throw_deviation),
    n = n()
  )

data_per_group <- data_per_ppt %>%
  group_by(prior_anim, trial_num_in_block) %>%
  summarise(
    mean_deviation = mean(ppt_mean_deviation),
    ci_deviation = vector_confint(ppt_mean_deviation),
    n = sum(n)
  )

# set up plot
p <- data_per_group %>%
  ggplot(
    aes(
      x = trial_num_in_block, y = mean_deviation,
      colour = prior_anim, fill = prior_anim
    )
  ) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(
    x = "Trial Number",
    y = "Throw Angle (°)"
  )

# add horizontal lines
p <- p +
  geom_hline(
    yintercept = c(0, -30), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(-15), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  )

# add data points
p <- p + geom_beeswarm(
  data = data_per_ppt,
  aes(y = ppt_mean_deviation, 
      colour = prior_anim),
  size = 1, dodge.width = 0.5
  ) + geom_ribbon(
    aes(
      ymin = mean_deviation - ci_deviation,
      ymax = mean_deviation + ci_deviation
      ),
    colour = NA, alpha = 0.3
  ) + geom_line()

ggplotly(p)
```


```{r, include=FALSE}
## EMPTY
```


# Deprecated (Don't Run)

## Success manifolds
### Without any tilts
```{r, fig.width=9, fig.height=20}
# ggplotly(plot_success_manifold_no_tilt())
plot_success_manifold_no_tilt()
```

### With tilt present
```{r, fig.width=9, fig.height=20}
ggplotly(plot_success_manifold_tilt())
```


```{r, include=FALSE}
NULL
```

