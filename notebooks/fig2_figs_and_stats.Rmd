---
title: "Billiards and Tilts Analysis Notebook"
author: "Shanaathanan Modchalingam"
output: 
  html_notebook:
    toc: true
    toc_float: true
    number_sections: true
    df_print: paged
    code_folding: hide
---


```{r setup, include=FALSE, warning=FALSE}
# clean environment
rm(list = ls())
# set seed
set.seed(1234)

source("../src/helper_funcs.R")
source("../scripts/figure_funcs.R")
library(data.table)
library(tidyverse)
library(ggbeeswarm)

# for statistics
library(ez) # for ANOVAs
library(afex) # for ANOVAs
library(emmeans)
library(effectsize) # for eta-squared
library(BayesFactor)
library(bayestestR)

library(furrr)
plan(multisession)

options(dplyr.summarise.inform = FALSE)

# vars
omnibus_path <- "../data/processed/omnibus/omnibus_raw.csv"
num_exps <- 7
```



## Load all of the throw data
```{r}
# Note: this notebook right now REQUIRES that the analysis notebook be run to
# make the fits, or that the data folder contains the fits

# load omnibus dataframe
omnibus_df <- read_delim("../data/processed/omnibus/omnibus_raw.csv",
  delim = ",",
  col_types = cols(
    .default = col_double(),
    type = col_factor(),
    ppid = col_factor(),
    exp_label = col_factor(),
    experiment = col_factor(),
    hand = col_factor(),
    camera_tilt = col_factor(),
    surface_tilt = col_factor(),
    target = col_factor(),
    test_type = col_factor(),
    phase = col_factor(),
    learning_and_decay_curves = col_factor(),
    prior_anim = col_factor(),
    baseline_block = col_logical(),
    alt_washout_block = col_logical(),
    alt_all_washout_block = col_logical(),
    task_type = col_factor(),
    surface = col_factor(),
    anim_type = col_factor()
  )
) %>% # filter out practice blocks
  filter(
    block_num > 4,
    !(ppid %in% c(2, 81, 82, 83))
  )

# load exponential decay fits
init_learning_rates <- read_csv(
  "../data/processed/learning_rate_df.csv",
  col_types = cols(
    .default = col_double(),
    experiment = col_factor(),
    phase = col_factor()
  )
) %>%
  mutate(experiment = factor(
    experiment,
    levels = c(
      "accel_cued_tilt", "accel_uncued",
      "curved_cued_tilt", "curved_uncued",
      "rot30_cued_tilt", "rot30_uncued",
      "rot15_cued_tilt", "rot15_uncued",
      "a_ball_roll_animate_surface"
    )
  ))

init_learning_rates_3par <- read_csv(
  "../data/processed/learning_rate_df_3par.csv",
  col_types = cols(
    .default = col_double(),
    experiment = col_factor(),
    phase = col_factor()
  )
) %>%
  mutate(experiment = factor(
    experiment,
    levels = c(
      "accel_cued_tilt", "accel_uncued",
      "curved_cued_tilt", "curved_uncued",
      "rot30_cued_tilt", "rot30_uncued",
      "rot15_cued_tilt", "rot15_uncued",
      "a_ball_roll_animate_surface"
    )
  ))

anim_learning_rates <- read_csv(
  "../data/processed/learning_rate_df_anim.csv",
  col_types = cols(
    .default = col_double(),
    ppid = col_factor(),
    experiment = col_factor(),
    phase = col_factor()
  )
) %>%
  mutate(experiment = factor(
    experiment,
    levels = c(
      "rot30_cued_tilt", "rot30_uncued",
      "half_anim", "full_anim"
    )
  ))

alt_washout_rates <- read_csv(
  "../data/processed/exp_fits_alt_washout_curves.csv",
  col_types = cols(
    .default = col_double(),
    experiment = col_factor(),
    phase = col_factor()
  )
) %>%
  mutate(experiment = factor(
    experiment,
    levels = c(
      "accel_cued_tilt", "accel_uncued",
      "curved_cued_tilt", "curved_uncued",
      "rot30_cued_tilt", "rot30_uncued",
      "rot15_cued_tilt", "rot15_uncued",
      "a_ball_roll_animate_surface"
    )
  ))

alt_all_washout_rates <- read_csv(
  "../data/processed/exp_fits_alt_all_washout_curves.csv",
  col_types = cols(
    .default = col_double(),
    experiment = col_factor(),
    phase = col_factor()
  )
) %>%
  mutate(experiment = factor(
    experiment,
    levels = c(
      "accel_cued_tilt", "accel_uncued",
      "curved_cued_tilt", "curved_uncued",
      "rot30_cued_tilt", "rot30_uncued",
      "rot15_cued_tilt", "rot15_uncued",
      "a_ball_roll_animate_surface"
    )
  ))

fitted_learning_rate_df <- read_csv(
  "../data/processed/fit_curves/fitted_learning_rate_df.csv",
  col_types = cols(
    .default = col_double(),
    experiment = col_factor(),
    phase = col_factor()
  )
) %>%
  mutate(experiment = factor(
    experiment,
    levels = c(
      "accel_cued_tilt", "accel_uncued",
      "curved_cued_tilt", "curved_uncued",
      "rot30_cued_tilt", "rot30_uncued",
      "rot15_cued_tilt", "rot15_uncued",
      "a_ball_roll_animate_surface"
    )
  ))

fitted_alt_washout_df <- read_csv(
  "../data/processed/fit_curves/fitted_exp_fits_alt_washout_curves.csv",
  col_types = cols(
    .default = col_double(),
    experiment = col_factor(),
    phase = col_factor()
  )
) %>%
  mutate(experiment = factor(
    experiment,
    levels = c(
      "accel_cued_tilt", "accel_uncued",
      "curved_cued_tilt", "curved_uncued",
      "rot30_cued_tilt", "rot30_uncued",
      "rot15_cued_tilt", "rot15_uncued",
      "a_ball_roll_animate_surface"
    )
  ))

```

# Figure 2: Learning Curves
## All data
```{r, fig.width=10, fig.height=6, out.width="100%"}
# filter out data
data_per_ppt <- omnibus_df %>%
  filter(
    phase != "transfer",
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    ),
    trial_num >= 214
  ) %>%
  mutate(
    trial_num = ifelse(
      trial_num >= 335,
      trial_num - 1,
      trial_num
    )
  )

# vars
bl_trial_shift <- 213
num_exps <- 4

# make per_group df
data_per_group <- data_per_ppt %>%
  group_by(experiment, phase, test_type, block_num, trial_num, learning_and_decay_curves) %>%
  summarise(
    mean_deviation = mean(throw_deviation),
    ci_deviation = vector_confint(throw_deviation),
    n = n(),
    .groups = "drop"
  ) %>%
  arrange(experiment, trial_num)

# set up plot
p <- data_per_group %>%
  filter(block_num != 14) %>%
  ggplot(
    aes(
      x = trial_num - bl_trial_shift,
      y = mean_deviation,
      colour = experiment
    )
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  labs(
    x = "Trial",
    y = "Throw Angle (°)"
  ) + # add horizontal lines
  geom_hline(
    yintercept = c(0, -30), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(-15), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) + # add vertical lines
  geom_vline(
    xintercept = c(333.5 - bl_trial_shift), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # scale axes
  scale_y_continuous(
    limits = c(-42, 5),
    breaks = c(0, -15, -30),
    labels = c(0, -15, -30)
  ) +
  scale_x_continuous(
    # limits = c(0, 160),
    breaks = c(0, 40, 80, 120, 160),
    labels = c(0, 40, 80, 120, 160)
  ) +
  # add confidence intervals and data points
  geom_ribbon(
    aes(
      ymin = mean_deviation - ci_deviation,
      ymax = mean_deviation + ci_deviation,
      fill = experiment
    ),
    colour = NA, alpha = 0.3
  ) +
  geom_ribbon(
    data = data_per_group %>%
      filter(block_num == 14),
    aes(
      ymin = mean_deviation - ci_deviation,
      ymax = mean_deviation + ci_deviation,
      fill = experiment
    ),
    colour = NA, alpha = 0.3
  ) +
  geom_line() +
  geom_line(
    data = data_per_group %>%
      filter(block_num == 14)
  ) + # set colour palette
  scale_colour_manual(
    values = pallete_list
  ) +
  scale_fill_manual(
    values = pallete_list
  )

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_all.pdf", device = "pdf",
    height = 2, width = 2.75
  )
}

p
```

## Phases (used for model fitting)
```{r, fig.width=10, fig.height=6, out.width="100%"}
# filter out just the trials of interest
data_per_group <- data_per_group %>%
  filter(
    phase != "other", phase != "transfer",
    learning_and_decay_curves == 1
  )

# add a dummy column with repeating sequence
# NOTE: this can't be combined with above since we are using nrow
data_per_group <- data_per_group %>%
  mutate(dummy_x = rep(1:(nrow(data_per_group) / num_exps),
    length.out = nrow(data_per_group)
  ))

# set up plot
p <- data_per_group %>%
  ggplot(
    aes(
      x = dummy_x, y = mean_deviation, colour = experiment
    )
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  labs(
    x = "Phases",
    y = "Throw Angle (°)"
  ) + # add horizontal lines
  geom_hline(
    yintercept = c(0, -30), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(-15), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) + # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(values = pallete_list) + # scale axes
  scale_y_continuous(
    limits = c(-42, 5),
    breaks = c(0, -15, -30),
    labels = c(0, -15, -30)
  ) +
  scale_x_continuous(
    # limits = c(0, 160),
    breaks = c(0, 40, 80, 120),
    labels = c(0, 1, 2, 3)
  )

# add confidence intervals and data points
for (uniq_phase in unique(data_per_group$phase)) {
  # get the data for this block
  to_plot_data <- filter(data_per_group, phase == uniq_phase)

  p <- p + geom_ribbon(
    data = to_plot_data,
    aes(
      ymin = mean_deviation - ci_deviation,
      ymax = mean_deviation + ci_deviation,
      fill = experiment
    ), colour = NA, alpha = 0.3
  ) + geom_line(
    data = to_plot_data
  )
}

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_phases.pdf", device = "pdf",
    height = 2, width = 2.75
  )
}

p
```

To better compare across all our studies, we normalize all our data using the last 2 trial-sets in the Initial Learning phase.

Note: we can see if each group is different from 1 at the end of training to see if they fully adapted by the end of the Initial Learning phase.

## Normalized Training Phases
```{r, fig.width=10, fig.height=6, out.width="100%"}
# rest of the exps
data_per_group <- omnibus_df %>%
  filter(
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    ),
    trial_num >= 214,
    phase == "training",
    learning_and_decay_curves == 1
  ) %>%
  group_by(experiment, phase, test_type, trial_num) %>%
  summarise(
    mean_deviation = mean(norm_throw_deviation),
    ci_deviation = vector_confint(norm_throw_deviation),
    .groups = "drop"
  ) %>%
  arrange(experiment, trial_num)

# add a dummy column with repeating sequence
# NOTE: this can't be combined with above since we are using nrow
data_per_group <- data_per_group %>%
  mutate(dummy_x = rep(1:(nrow(data_per_group) / num_exps),
    length.out = nrow(data_per_group)
  ))

# set up plot
p <- data_per_group %>%
  ggplot(
    aes(
      x = dummy_x, y = mean_deviation, colour = experiment
    )
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  labs(
    x = "Trial",
    y = "Normalized Throw Angle"
  ) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.5, 1.5), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(values = pallete_list) + # scale axes
  scale_y_continuous(
    breaks = c(0, 0.5, 1, 1.5),
    labels = c(0, 0.5, 1, 1.5),
    limits = c(0, 1.5)
  ) +
  scale_x_continuous(
    breaks = curve_x_breaks,
    labels = curve_x_breaks
  )

# add confidence intervals and data points
for (uniq_phase in unique(data_per_group$phase)) {
  # get the data for this block
  to_plot_data <- filter(data_per_group, phase == uniq_phase)

  p <- p + geom_ribbon(
    data = to_plot_data,
    aes(
      ymin = mean_deviation - ci_deviation,
      ymax = mean_deviation + ci_deviation,
      fill = experiment
    ), colour = NA, alpha = 0.20
  ) + geom_line(
    data = to_plot_data,
    alpha = 0.5
  )
}

# fitted curves
# p <- p + geom_line(
#   data = filter(
#     fitted_learning_rate_df,
#     experiment %in% c(
#       "accel_uncued", "accel_cued_tilt",
#       "rot30_uncued", "rot30_cued_tilt"
#     ),
#     phase == "training"
#   ),
#   aes(x = x + 1, y = y), linewidth = 0.5, linetype = "31"
# )

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_normalized_training.pdf", device = "pdf",
    height = 2, width = curve_fig_width
  )
}

p
```
## Training - Fitted Curves
```{r}
fitted_data <- fitted_learning_rate_df %>%
  filter(
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    ),
    phase == "training"
  ) %>%
  mutate(
    pert = factor(str_split_fixed(experiment, "_", 2)[, 1]),
    cue = factor(str_split_fixed(experiment, "_", 2)[, 2])
  )

p <- fitted_data %>%
  ggplot(
    aes(x = x + 1, y = y, colour = experiment)
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  labs(
    x = "Trial",
    y = "Normalized Throw Angle"
  ) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.5, 1.5), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(values = pallete_list) + # scale axes
  scale_y_continuous(
    breaks = c(0, 0.5, 1, 1.5),
    labels = c(0, 0.5, 1, 1.5),
    limits = c(0, 1.5)
  ) +
  scale_x_continuous(
    breaks = curve_x_breaks,
    labels = curve_x_breaks
  ) +
  geom_line()

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_training_fitted_only.pdf", device = "pdf",
    height = 2, width = curve_fig_width
  )
}

p
```


## Training - Fit Learning Rates
```{r, fig.width=10, fig.height=6, out.width="100%"}
data_per_ppt <- init_learning_rates %>%
  filter(
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    ),
    phase == "training"
  ) %>%
  mutate(
    pert = factor(str_split_fixed(experiment, "_", 2)[, 1]),
    cue = factor(str_split_fixed(experiment, "_", 2)[, 2]),
    ppid = factor(ppid)
  )

data_per_group <- data_per_ppt %>%
  group_by(experiment, phase) %>%
  summarise(
    mean_learning_rate = mean(exp_fit_lambda),
    ci_learning_rate = vector_confint(exp_fit_lambda),
    mean_high = mean(exp_fit_N0),
    ci_high = vector_confint(exp_fit_N0),
    .groups = "drop"
  )

p <- data_per_group %>%
  ggplot(
    aes(x = experiment, y = mean_learning_rate, colour = experiment)
  ) +
  theme_classic() +
  labs(
    x = per_group_x_labs,
    y = "Learning Rate"
  ) +
  # remove all x axis labels
  theme(
    # axis.text.x = element_blank(),
    legend.position = "none",
    # strip.text.x = element_blank(),
    text = element_text(size = text_size)
  ) +
  # colour legend settings
  guides(
    colour = guide_legend(override.aes = list(alpha = 1))
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(
    values = pallete_list
  ) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.25, 0.5, 0.75), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # y-axis scale
  scale_y_continuous(
    # limits = c(-35, 5),
    breaks = c(0, 0.25, 0.5, 0.75, 1),
    labels = c(0, 0.25, 0.5, 0.75, 1)
  ) +
  scale_x_discrete(
    # limits = c(-35, 5),
    labels = c(0, 0, 0, 0)
  ) +
  # add data points
  geom_beeswarm(
    data = data_per_ppt,
    aes(
      y = exp_fit_lambda
    ),
    alpha = 0.1,
    size = 1
  ) +
  geom_linerange(aes(
    ymin = mean_learning_rate - ci_learning_rate,
    ymax = mean_learning_rate + ci_learning_rate
  ), alpha = 0.5, lwd = 2) +
  geom_point()

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_training_learning_rates.pdf", device = "pdf",
    height = 2, width = per_group_fig_width
  )
}

p
```
### Statistics

We are using the afex package for the aov_car function. This allows for used mixed (within/between) factor ANOVAs.
Here is an example formula for using aov_car: dependent_variable ~ between_factor1 * between_factor2 + Error(subject/(within_factor * within_factor))
```{r}
(temp_ANOVA <- aov_car(
  exp_fit_lambda ~ pert * cue + Error(ppid),
  data_per_ppt,
  include_aov = TRUE
))

print("Bayes anovas and bayes factors:")
print("")

bf <- anovaBF(exp_fit_lambda ~ pert * cue, data = data.frame(data_per_ppt), progress = FALSE)
print(bf)
print(bayesfactor_inclusion(bf))
```
Pairwise comparisons:
```{r}
# posthoc tests
# (m1 <- emmeans(temp_ANOVA, ~pert))
# print("Pairwise comparisons:")
# print(summary(pairs(m1), adjust = "tukey")) # Note: default multiplicity correction for pairs summary is Tukey HSD

# Note: default multiplicity correction for pairs summary is Tukey HSD
print("----------------------------- EMMs -----------------------------")
emms_obj <- emmeans(temp_ANOVA, "cue")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("----------------------------- Full Tukey HSD -----------------------------")
print(TukeyHSD(temp_ANOVA$aov))

print(eff_size(emmeans(temp_ANOVA$aov, c("pert", "cue")),
  edf = temp_ANOVA$anova_table$`den Df`[1],
  sigma = sigma(temp_ANOVA$lm)
))
```


## Training - Fit High Points (Asymptotes)
```{r, fig.width=10, fig.height=6, out.width="100%"}
p <- data_per_group %>%
  ggplot(
    aes(x = experiment, y = mean_high, colour = experiment)
  ) +
  theme_classic() +
  labs(
    x = per_group_x_labs,
    y = "Asymptote of Adaptation"
  ) +
  # for the colour legend, only show the first 7
  # Note this doesn't work for the plotly plot
  guides(
    colour = guide_legend(override.aes = list(alpha = 1))
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(values = pallete_list) +
  # add horizontal lines
  geom_hline(
    yintercept = c(1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.5, 1.5), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # y-axis scale
  scale_y_continuous(
    limits = c(0.5, 1.75),
    breaks = c(0.5, 0.75, 1, 1.25, 1.5),
    labels = c(0.5, 0.75, 1, 1.25, 1.5)
  ) +
  scale_x_discrete(
    labels = c(0, 0, 0, 0)
  ) +
  # remove all x axis labels
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  # add data points
  geom_beeswarm(
    data = data_per_ppt,
    aes(
      y = exp_fit_N0
    ),
    alpha = 0.1,
    size = 1
  ) +
  geom_linerange(aes(
    ymin = mean_high - ci_high,
    ymax = mean_high + ci_high
  ), alpha = 0.5, lwd = 2) +
  geom_point()

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_training_asymptotes.pdf", device = "pdf",
    height = 2, width = per_group_fig_width
  )
}

p
```
```{r}
(temp_ANOVA <- aov_car(
  exp_fit_N0 ~ pert * cue + Error(ppid),
  data_per_ppt,
  include_aov = TRUE
))

print("Bayes anovas and bayes factors:")
print("")

bf <- anovaBF(exp_fit_N0 ~ pert * cue, data = data.frame(data_per_ppt), progress = FALSE)
print(bf)
print(bayesfactor_inclusion(bf))
```
Pairwise comparisons:
```{r}
# posthoc tests
# (m1 <- emmeans(temp_ANOVA, ~pert))
# print("Pairwise comparisons:")
# print(summary(pairs(m1), adjust = "tukey")) # Note: default multiplicity correction for pairs summary is Tukey HSD

# Note: default multiplicity correction for pairs summary is Tukey HSD
print("----------------------------- EMMs -----------------------------")
emms_obj <- emmeans(temp_ANOVA, "pert")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("----------------------------- Full Tukey HSD -----------------------------")
print(TukeyHSD(temp_ANOVA$aov))

print(eff_size(emmeans(temp_ANOVA$aov, c("pert", "cue")),
  edf = temp_ANOVA$anova_table$`den Df`[1],
  sigma = sigma(temp_ANOVA$lm)
))
```

## Normalized Washout Phases
```{r, fig.width=10, fig.height=6, out.width="100%"}
# rest of the exps
data_per_group <- omnibus_df %>%
  filter(
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    ),
    trial_num >= 214,
    phase == "washout",
    learning_and_decay_curves == 1
  ) %>%
  group_by(experiment, phase, trial_num) %>%
  summarise(
    mean_deviation = mean(norm_throw_deviation),
    ci_deviation = vector_confint(norm_throw_deviation),
    .groups = "drop"
  ) %>%
  arrange(experiment, trial_num)

# add a dummy column with repeating sequence
# NOTE: this can't be combined with above since we are using nrow
data_per_group <- data_per_group %>%
  mutate(dummy_x = rep(1:(nrow(data_per_group) / num_exps),
    length.out = nrow(data_per_group)
  ))

# set up plot
p <- data_per_group %>%
  ggplot(
    aes(
      x = dummy_x, y = mean_deviation, colour = experiment
    )
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  labs(
    x = "Trial",
    y = "Normalized Throw Angle"
  ) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.5, 1.5), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(values = pallete_list) + # scale axes
  scale_y_continuous(
    breaks = c(0, 0.5, 1, 1.5),
    labels = c(0, 0.5, 1, 1.5),
    limits = c(-0.25, 1.5)
  ) +
  scale_x_continuous(
    breaks = curve_x_breaks,
    labels = curve_x_breaks
  )

# add confidence intervals and data points
for (uniq_phase in unique(data_per_group$phase)) {
  # get the data for this block
  to_plot_data <- filter(data_per_group, phase == uniq_phase)

  p <- p + geom_ribbon(
    data = to_plot_data,
    aes(
      ymin = mean_deviation - ci_deviation,
      ymax = mean_deviation + ci_deviation,
      fill = experiment
    ), colour = NA, alpha = 0.3
  ) + geom_line(
    data = to_plot_data
  )
}

# # fitted curves
# p <- p + geom_line(
#   data = filter(
#     fitted_learning_rate_df,
#     experiment %in% c(
#       "accel_uncued", "accel_cued_tilt",
#       "rot30_uncued", "rot30_cued_tilt"
#     ),
#     phase == "washout"
#   ),
#   aes(x = x + 1, y = y)
# )

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_normalized_washout.pdf", device = "pdf",
    height = 2, width = curve_fig_width
  )
}

p
```

```{r}
fitted_data <- fitted_learning_rate_df %>%
  filter(
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    ),
    phase == "washout"
  ) %>%
  mutate(
    pert = factor(str_split_fixed(experiment, "_", 2)[, 1]),
    cue = factor(str_split_fixed(experiment, "_", 2)[, 2])
  )

p <- fitted_data %>%
  ggplot(
    aes(x = x + 1, y = y, colour = experiment)
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  labs(
    x = "Trial",
    y = "Normalized Throw Angle"
  ) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.5, 1.5), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(values = pallete_list) + # scale axes
  scale_y_continuous(
    breaks = c(0, 0.5, 1, 1.5),
    labels = c(0, 0.5, 1, 1.5),
    limits = c(-0.25, 1.5)
  ) +
  scale_x_continuous(
    breaks = curve_x_breaks,
    labels = curve_x_breaks
  ) +
  geom_line()

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_washout_fitted_only.pdf", device = "pdf",
    height = 2, width = curve_fig_width
  )
}

p
```

## Washout - Fit Learning Rates
```{r, fig.width=10, fig.height=6, out.width="100%"}
data_per_ppt <- init_learning_rates %>%
  filter(
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    ),
    phase == "washout"
  ) %>%
  mutate(
    pert = factor(str_split_fixed(experiment, "_", 2)[, 1]),
    cue = factor(str_split_fixed(experiment, "_", 2)[, 2]),
    ppid = factor(ppid)
  )

data_per_group <- data_per_ppt %>%
  group_by(experiment, phase) %>%
  summarise(
    mean_learning_rate = mean(exp_fit_lambda),
    ci_learning_rate = vector_confint(exp_fit_lambda),
    mean_high = mean(exp_fit_N0),
    ci_high = vector_confint(exp_fit_N0),
    .groups = "drop"
  )

p <- data_per_group %>%
  ggplot(
    aes(x = experiment, y = mean_learning_rate, colour = experiment)
  ) +
  theme_classic() +
  labs(
    x = per_group_x_labs,
    y = "Decay Rate"
  ) +
  # remove all x axis labels
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  # colour legend settings
  guides(
    colour = guide_legend(override.aes = list(alpha = 1))
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(
    values = pallete_list
  ) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.25, 0.5, 0.75), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # y-axis scale
  scale_y_continuous(
    # limits = c(-35, 5),
    breaks = c(0, 0.25, 0.5, 0.75, 1),
    labels = c(0, 0.25, 0.5, 0.75, 1)
  ) +
  scale_x_discrete(
    labels = c(0, 0, 0, 0)
  ) +
  # add data points
  geom_beeswarm(
    data = data_per_ppt,
    aes(
      y = exp_fit_lambda
    ),
    alpha = 0.1,
    size = 1
  ) +
  geom_linerange(aes(
    ymin = mean_learning_rate - ci_learning_rate,
    ymax = mean_learning_rate + ci_learning_rate
  ), alpha = 0.5, lwd = 2) +
  geom_point()

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_washout_learning_rates.pdf", device = "pdf",
    height = 2, width = per_group_fig_width
  )
}

p
```
```{r}
(temp_ANOVA <- aov_car(
  exp_fit_lambda ~ pert * cue + Error(ppid),
  data_per_ppt,
  include_aov = TRUE
))

print("Bayes anovas and bayes factors:")
print("")

bf <- anovaBF(exp_fit_lambda ~ pert * cue, data = data.frame(data_per_ppt), progress = FALSE)
print(bf)
print(bayesfactor_inclusion(bf))
```
Pairwise comparisons:
```{r}
# posthoc tests
# (m1 <- emmeans(temp_ANOVA, ~pert))
# print("Pairwise comparisons:")
# print(summary(pairs(m1), adjust = "tukey")) # Note: default multiplicity correction for pairs summary is Tukey HSD

# Note: default multiplicity correction for pairs summary is Tukey HSD
print("-------------------------- EMMs cue --------------------------")
emms_obj <- emmeans(temp_ANOVA, "cue")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("-------------------------- EMMs perts --------------------------")
emms_obj <- emmeans(temp_ANOVA, "pert")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("----------------------------- Full Tukey HSD -----------------------------")
print(TukeyHSD(temp_ANOVA$aov))

print(eff_size(emmeans(temp_ANOVA$aov, c("pert", "cue")),
  edf = temp_ANOVA$anova_table$`den Df`[1],
  sigma = sigma(temp_ANOVA$lm)
))
```

## Washout - Fit High Points (Starts)
```{r, fig.width=10, fig.height=6, out.width="100%"}
p <- data_per_group %>%
  ggplot(
    aes(x = experiment, y = mean_high, colour = experiment)
  ) +
  theme_classic() +
  labs(
    x = per_group_x_labs,
    y = "Start Point of Decay"
  ) +
  # for the colour legend, only show the first 7
  # Note this doesn't work for the plotly plot
  guides(
    colour = guide_legend(override.aes = list(alpha = 1))
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(values = pallete_list) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.5, 1.5), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # y-axis scale
  scale_y_continuous(
    limits = c(-0.5, 1.6),
    breaks = c(-0.5, 0, 0.5, 1, 1.5),
    labels = c(-0.5, 0, 0.5, 1, 1.5)
  ) +
  scale_x_discrete(
    labels = c(0, 0, 0, 0)
  ) +
  # remove all x axis labels
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  # add data points
  geom_beeswarm(
    data = data_per_ppt,
    aes(
      y = exp_fit_N0
    ),
    alpha = 0.1,
    size = 1
  ) +
  geom_linerange(aes(
    ymin = mean_high - ci_high,
    ymax = mean_high + ci_high
  ), alpha = 0.5, lwd = 2) +
  geom_point()

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_washout_starts.pdf", device = "pdf",
    height = 2, width = per_group_fig_width
  )
}

p
```

```{r}
(temp_ANOVA <- aov_car(
  exp_fit_N0 ~ pert * cue + Error(ppid),
  data_per_ppt,
  include_aov = TRUE
))

print("Bayes anovas and bayes factors:")
print("")

bf <- anovaBF(exp_fit_N0 ~ pert * cue, data = data.frame(data_per_ppt), progress = FALSE)
print(bf)
print(bayesfactor_inclusion(bf))
```
Pairwise comparisons:
```{r}
# posthoc tests
# (m1 <- emmeans(temp_ANOVA, ~pert))
# print("Pairwise comparisons:")
# print(summary(pairs(m1), adjust = "tukey")) # Note: default multiplicity correction for pairs summary is Tukey HSD

# Note: default multiplicity correction for pairs summary is Tukey HSD
print("-------------------------- EMMs cue --------------------------")
emms_obj <- emmeans(temp_ANOVA, "cue")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("-------------------------- EMMs perts --------------------------")
emms_obj <- emmeans(temp_ANOVA, "pert")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("----------------------------- Full Tukey HSD -----------------------------")
print(TukeyHSD(temp_ANOVA$aov))

print(eff_size(emmeans(temp_ANOVA$aov, c("pert", "cue")),
  edf = temp_ANOVA$anova_table$`den Df`[1],
  sigma = sigma(temp_ANOVA$lm)
))
```

# Alternate Washout Phases 
These include the last trial of the Training phase for all Cued conditions.

## Normalized Washout Phases
```{r, fig.width=10, fig.height=6, out.width="100%"}
# rest of the exps
data_per_group <- omnibus_df %>%
  filter(
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    ),
    trial_num >= 214,
    alt_washout_block == TRUE,
  ) %>%
  arrange(experiment, ppid, trial_num) %>%
  group_by(experiment, trial_num) %>%
  summarise(
    mean_deviation = mean(norm_throw_deviation),
    ci_deviation = vector_confint(norm_throw_deviation),
    .groups = "drop"
  )

# NOTE: this can't be combined with above since we are using nrow
data_per_group <- data_per_group %>%
  mutate(dummy_x = rep(1:40,
    length.out = nrow(data_per_group)
  ))

# add a dummy column with repeating sequence


# set up plot
p <- data_per_group %>%
  ggplot(
    aes(
      x = dummy_x, y = mean_deviation, colour = experiment
    )
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  labs(
    x = "Trial",
    y = "Normalized Throw Angle"
  ) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.5, 1.5), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(values = pallete_list) + # scale axes
  scale_y_continuous(
    breaks = c(0, 0.5, 1, 1.5),
    labels = c(0, 0.5, 1, 1.5),
    limits = c(-0.25, 1.5)
  ) +
  scale_x_continuous(
    breaks = curve_x_breaks,
    labels = curve_x_breaks
  )

# add confidence intervals and data points
for (uniq_exp in unique(data_per_group$experiment)) {
  # get the data for this block
  to_plot_data <- filter(data_per_group, experiment == uniq_exp)

  p <- p + geom_ribbon(
    data = to_plot_data,
    aes(
      ymin = mean_deviation - ci_deviation,
      ymax = mean_deviation + ci_deviation,
      fill = experiment
    ), colour = NA, alpha = 0.3
  ) + geom_line(
    data = to_plot_data
  )
}

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_alt_washout.pdf", device = "pdf",
    height = 2, width = curve_fig_width
  )
}

p
# ggplotly(p)
```


```{r}
fitted_data <- fitted_alt_washout_df %>%
  filter(
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    ),
    phase == "washout"
  ) %>%
  mutate(
    pert = factor(str_split_fixed(experiment, "_", 2)[, 1]),
    cue = factor(str_split_fixed(experiment, "_", 2)[, 2])
  )

p <- fitted_data %>%
  ggplot(
    aes(x = x + 1, y = y, colour = experiment)
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  labs(
    x = "Trial",
    y = "Normalized Throw Angle"
  ) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.5, 1.5), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(values = pallete_list) + # scale axes
  scale_y_continuous(
    breaks = c(0, 0.5, 1, 1.5),
    labels = c(0, 0.5, 1, 1.5),
    limits = c(-0.25, 1.5)
  ) +
  scale_x_continuous(
    breaks = curve_x_breaks,
    labels = curve_x_breaks
  ) +
  geom_line()

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_alt_washout_fitted_only.pdf", device = "pdf",
    height = 2, width = curve_fig_width
  )
}

p
```

## Washout - Fit Learning Rates
```{r, fig.width=10, fig.height=6, out.width="100%"}
data_per_ppt <- alt_washout_rates %>%
  filter(
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    )
  ) %>%
  mutate(
    pert = factor(str_split_fixed(experiment, "_", 2)[, 1]),
    cue = factor(str_split_fixed(experiment, "_", 2)[, 2]),
    ppid = factor(ppid)
  )

data_per_group <- data_per_ppt %>%
  group_by(experiment) %>%
  summarise(
    mean_learning_rate = mean(exp_fit_lambda),
    ci_learning_rate = vector_confint(exp_fit_lambda),
    mean_high = mean(exp_fit_N0),
    ci_high = vector_confint(exp_fit_N0),
    .groups = "drop"
  )

p <- data_per_group %>%
  ggplot(
    aes(x = experiment, y = mean_learning_rate, colour = experiment)
  ) +
  theme_classic() +
  labs(
    x = per_group_x_labs,
    y = "Decay Rate"
  ) +
  # remove all x axis labels
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  # colour legend settings
  guides(
    colour = guide_legend(override.aes = list(alpha = 1))
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(
    values = pallete_list
  ) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.25, 0.5, 0.75), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # y-axis scale
  scale_y_continuous(
    # limits = c(-35, 5),
    breaks = c(0, 0.25, 0.5, 0.75, 1),
    labels = c(0, 0.25, 0.5, 0.75, 1)
  ) +
  scale_x_discrete(
    labels = c(0, 0, 0, 0)
  ) +
  # add data points
  geom_beeswarm(
    data = data_per_ppt,
    aes(
      y = exp_fit_lambda
    ),
    alpha = 0.1,
    size = 1
  ) +
  geom_linerange(aes(
    ymin = mean_learning_rate - ci_learning_rate,
    ymax = mean_learning_rate + ci_learning_rate
  ), alpha = 0.5, lwd = 2) +
  geom_point()

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_alt_washout_learning_rates.pdf", device = "pdf",
    height = 2, width = per_group_fig_width
  )
}

p
```

```{r}
(temp_ANOVA <- aov_car(
  exp_fit_lambda ~ pert * cue + Error(ppid),
  data_per_ppt,
  include_aov = TRUE
))

print("Bayes anovas and bayes factors:")
print("")

bf <- anovaBF(exp_fit_lambda ~ pert * cue, data = data.frame(data_per_ppt), progress = FALSE)
print(bf)
print(bayesfactor_inclusion(bf))
```
Pairwise comparisons:
```{r}
# posthoc tests
# (m1 <- emmeans(temp_ANOVA, ~pert))
# print("Pairwise comparisons:")
# print(summary(pairs(m1), adjust = "tukey")) # Note: default multiplicity correction for pairs summary is Tukey HSD

# Note: default multiplicity correction for pairs summary is Tukey HSD
print("-------------------------- EMMs cue --------------------------")
emms_obj <- emmeans(temp_ANOVA, "cue")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("-------------------------- EMMs perts --------------------------")
emms_obj <- emmeans(temp_ANOVA, "pert")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("----------------------------- Full Tukey HSD -----------------------------")
print(TukeyHSD(temp_ANOVA$aov))

print(eff_size(emmeans(temp_ANOVA$aov, c("pert", "cue")),
  edf = temp_ANOVA$anova_table$`den Df`[1],
  sigma = sigma(temp_ANOVA$lm)
))
```

## Washout - Fit High Points (Starts)
```{r, fig.width=10, fig.height=6, out.width="100%"}
p <- data_per_group %>%
  ggplot(
    aes(x = experiment, y = mean_high, colour = experiment)
  ) +
  theme_classic() +
  labs(
    x = per_group_x_labs,
    y = "Start Point of Decay"
  ) +
  # for the colour legend, only show the first 7
  # Note this doesn't work for the plotly plot
  guides(
    colour = guide_legend(override.aes = list(alpha = 1))
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(values = pallete_list) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.5, 1.5), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # y-axis scale
  scale_y_continuous(
    limits = c(-0.5, 1.6),
    breaks = c(-0.5, 0, 0.5, 1, 1.5),
    labels = c(-0.5, 0, 0.5, 1, 1.5)
  ) +
  scale_x_discrete(
    labels = c(0, 0, 0, 0)
  ) +
  # remove all x axis labels
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  # add data points
  geom_beeswarm(
    data = data_per_ppt,
    aes(
      y = exp_fit_N0
    ),
    alpha = 0.1,
    size = 1
  ) +
  geom_linerange(aes(
    ymin = mean_high - ci_high,
    ymax = mean_high + ci_high
  ), alpha = 0.5, lwd = 2) +
  geom_point()

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_alt_washout_starts.pdf", device = "pdf",
    height = 2, width = per_group_fig_width
  )
}

p
```

```{r}
(temp_ANOVA <- aov_car(
  exp_fit_N0 ~ pert * cue + Error(ppid),
  data_per_ppt,
  include_aov = TRUE
))

print("Bayes anovas and bayes factors:")
print("")

bf <- anovaBF(exp_fit_N0 ~ pert * cue, data = data.frame(data_per_ppt), progress = FALSE)
print(bf)
print(bayesfactor_inclusion(bf))
```
Pairwise comparisons:
```{r}
# posthoc tests
# (m1 <- emmeans(temp_ANOVA, ~pert))
# print("Pairwise comparisons:")
# print(summary(pairs(m1), adjust = "tukey")) # Note: default multiplicity correction for pairs summary is Tukey HSD

# Note: default multiplicity correction for pairs summary is Tukey HSD
print("-------------------------- EMMs cue --------------------------")
emms_obj <- emmeans(temp_ANOVA, "cue")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("-------------------------- EMMs perts --------------------------")
emms_obj <- emmeans(temp_ANOVA, "pert")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("----------------------------- Full Tukey HSD -----------------------------")
print(TukeyHSD(temp_ANOVA$aov))

print(eff_size(emmeans(temp_ANOVA$aov, c("pert", "cue")),
  edf = temp_ANOVA$anova_table$`den Df`[1],
  sigma = sigma(temp_ANOVA$lm)
))
```

# All-Group-Alternate Washout Phases 
These include the last trial of the Training phase for all conditions.

## Normalized Washout Phases
```{r, fig.width=10, fig.height=6, out.width="100%"}
# rest of the exps
data_per_group <- omnibus_df %>%
  filter(
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    ),
    trial_num >= 214,
    alt_all_washout_block == TRUE,
  ) %>%
  arrange(experiment, ppid, trial_num) %>%
  group_by(experiment, trial_num) %>%
  summarise(
    mean_deviation = mean(norm_throw_deviation),
    ci_deviation = vector_confint(norm_throw_deviation),
    .groups = "drop"
  )

# NOTE: this can't be combined with above since we are using nrow
data_per_group <- data_per_group %>%
  mutate(dummy_x = rep(1:41,
    length.out = nrow(data_per_group)
  ))

# add a dummy column with repeating sequence


# set up plot
p <- data_per_group %>%
  ggplot(
    aes(
      x = dummy_x, y = mean_deviation, colour = experiment
    )
  ) +
  theme_classic() +
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  labs(
    x = "Trial",
    y = "Normalized Throw Angle"
  ) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.5, 1.5), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(values = pallete_list) + # scale axes
  scale_y_continuous(
    breaks = c(0, 0.5, 1, 1.5),
    labels = c(0, 0.5, 1, 1.5)
  ) +
  scale_x_continuous(
    breaks = curve_x_breaks,
    labels = curve_x_breaks
  )

# add confidence intervals and data points
for (uniq_exp in unique(data_per_group$experiment)) {
  # get the data for this block
  to_plot_data <- filter(data_per_group, experiment == uniq_exp)

  p <- p + geom_ribbon(
    data = to_plot_data,
    aes(
      ymin = mean_deviation - ci_deviation,
      ymax = mean_deviation + ci_deviation,
      fill = experiment
    ), colour = NA, alpha = 0.3
  ) + geom_line(
    data = to_plot_data
  )
}

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_normalized_alt_all_washout.pdf", device = "pdf",
    height = 2, width = curve_fig_width
  )
}

p
# ggplotly(p)
```

## Washout - Fit Learning Rates
```{r, fig.width=10, fig.height=6, out.width="100%"}
data_per_ppt <- alt_all_washout_rates %>%
  filter(
    experiment %in% c(
      "accel_uncued", "accel_cued_tilt",
      "rot30_uncued", "rot30_cued_tilt"
    )
  ) %>%
  mutate(
    pert = factor(str_split_fixed(experiment, "_", 2)[, 1]),
    cue = factor(str_split_fixed(experiment, "_", 2)[, 2]),
    ppid = factor(ppid)
  )

data_per_group <- data_per_ppt %>%
  group_by(experiment) %>%
  summarise(
    mean_learning_rate = mean(exp_fit_lambda),
    ci_learning_rate = vector_confint(exp_fit_lambda),
    mean_high = mean(exp_fit_N0),
    ci_high = vector_confint(exp_fit_N0),
    .groups = "drop"
  )

p <- data_per_group %>%
  ggplot(
    aes(x = experiment, y = mean_learning_rate, colour = experiment)
  ) +
  theme_classic() +
  labs(
    x = per_group_x_labs,
    y = "Decay Rate"
  ) +
  # remove all x axis labels
  theme(
    legend.position = "none",
    text = element_text(size = text_size)
  ) +
  # colour legend settings
  guides(
    colour = guide_legend(override.aes = list(alpha = 1))
  ) +
  # set colour palette
  scale_colour_manual(values = pallete_list) +
  scale_fill_manual(
    values = pallete_list
  ) +
  # add horizontal lines
  geom_hline(
    yintercept = c(0, 1), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "solid"
  ) +
  geom_hline(
    yintercept = c(0.25, 0.5, 0.75), linewidth = 0.4,
    colour = "#CCCCCC", linetype = "dashed"
  ) +
  # y-axis scale
  scale_y_continuous(
    # limits = c(-35, 5),
    breaks = c(0, 0.25, 0.5, 0.75, 1),
    labels = c(0, 0.25, 0.5, 0.75, 1)
  ) +
  scale_x_discrete(
    labels = c(0, 0, 0, 0)
  ) +
  # add data points
  geom_beeswarm(
    data = data_per_ppt,
    aes(
      y = exp_fit_lambda
    ),
    alpha = 0.1,
    size = 1
  ) +
  geom_linerange(aes(
    ymin = mean_learning_rate - ci_learning_rate,
    ymax = mean_learning_rate + ci_learning_rate
  ), alpha = 0.5, lwd = 2) +
  geom_point()

# save
if (save_plots) {
  ggsave(
    p,
    filename = "../data/figs/paper_figs/fig2_initial_exps_alt_all_washout_learning_rates.pdf", device = "pdf",
    height = 2, width = per_group_fig_width
  )
}

p
```


```{r}
(temp_ANOVA <- aov_car(
  exp_fit_lambda ~ pert * cue + Error(ppid),
  data_per_ppt,
  include_aov = TRUE
))

print("Bayes anovas and bayes factors:")
print("")

bf <- anovaBF(exp_fit_lambda ~ pert * cue, data = data.frame(data_per_ppt), progress = FALSE)
print(bf)
print(bayesfactor_inclusion(bf))
```
Pairwise comparisons:
```{r}
# posthoc tests
# (m1 <- emmeans(temp_ANOVA, ~pert))
# print("Pairwise comparisons:")
# print(summary(pairs(m1), adjust = "tukey")) # Note: default multiplicity correction for pairs summary is Tukey HSD

# Note: default multiplicity correction for pairs summary is Tukey HSD
print("-------------------------- EMMs cue --------------------------")
emms_obj <- emmeans(temp_ANOVA, "cue")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("-------------------------- EMMs perts --------------------------")
emms_obj <- emmeans(temp_ANOVA, "pert")
print(pwpm(emms_obj, diffs = FALSE))

# Effect size is Cohen's D
eff_size(emms_obj, edf = temp_ANOVA$anova_table$`den Df`[1], sigma = sigma(temp_ANOVA$lm))

print("----------------------------- Full Tukey HSD -----------------------------")
print(TukeyHSD(temp_ANOVA$aov))

print(eff_size(emmeans(temp_ANOVA$aov, c("pert", "cue")),
  edf = temp_ANOVA$anova_table$`den Df`[1],
  sigma = sigma(temp_ANOVA$lm)
))
```